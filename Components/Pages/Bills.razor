@page "/bills"
@page "/bills/new"
@page "/bills/{BillId:int}"
@page "/expenses"
@inject IBillService BillService
@inject IVendorService VendorService
@inject IProductService ProductService
@inject IAccountService AccountService
@inject NavigationManager Navigation

<PageHeader Title="@GetPageTitle()" Subtitle="@GetPageSubtitle()">
    <ActionContent>
        @if (isViewing && viewingBill != null)
        {
            <button class="btn btn-secondary" @onclick="BackToList">
                ‚Üê Back
            </button>
            @if (viewingBill.Status == BillStatus.Draft)
            {
                <button class="btn btn-primary" @onclick="EditFromView">
                    ‚úèÔ∏è Edit
                </button>
            }
        }
        else if (!isEditing && !showQuickExpense)
        {
            <button class="btn btn-secondary" @onclick="ShowQuickExpenseForm">
                ‚ö° Quick Expense
            </button>
            <button class="btn btn-primary" @onclick="CreateNewBill">
                + New Bill
            </button>
        }
    </ActionContent>
</PageHeader>

@if (isLoading)
{
    <LoadingSpinner Text="Loading..." />
}
else if (showQuickExpense)
{
    @* Quick Expense Form *@
    <div class="quick-expense-container">
        <Card Title="Quick Expense Entry">
            <ChildContent>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger mb-4">@errorMessage</div>
                }
                
                <div class="form-row">
                    <div class="form-group flex-1">
                        <label class="form-label form-label-required">Vendor</label>
                        <select class="form-control" @bind="quickExpense.VendorId">
                            <option value="0">-- Select Vendor --</option>
                            @foreach (var vendor in vendors)
                            {
                                <option value="@vendor.Id">@vendor.FullName</option>
                            }
                        </select>
                    </div>
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" @bind="quickExpense.Date" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group flex-1">
                        <label class="form-label form-label-required">Expense Category</label>
                        <select class="form-control" @bind="quickExpense.AccountId">
                            <option value="0">-- Select Category --</option>
                            @foreach (var account in expenseAccounts)
                            {
                                <option value="@account.Id">@account.AccountNumber - @account.Name</option>
                            }
                        </select>
                    </div>
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label form-label-required">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" @bind="quickExpense.Amount" step="0.01" />
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" @bind="quickExpense.Description" 
                           placeholder="What was this expense for?" />
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" @onclick="CancelQuickExpense">Cancel</button>
                    <button class="btn btn-success" @onclick="SaveQuickExpense" disabled="@isSaving">
                        @(isSaving ? "Saving..." : "Save Expense")
                    </button>
                </div>
            </ChildContent>
        </Card>
    </div>
}
else if (isViewing && viewingBill != null)
{
    @* Bill Detail View *@
    <div class="bill-detail-container">
        <div class="bill-detail-grid">
            @* Left Column - Bill Details *@
            <div class="bill-detail-main">
                <Card>
                    <ChildContent>
                        <div class="bill-header">
                            <div class="bill-header-left">
                                <h2 class="bill-number">@viewingBill.TransactionNumber</h2>
                                <span class="badge @GetStatusBadgeClass(viewingBill.Status, viewingBill.IsOverdue)">
                                    @GetStatusDisplay(viewingBill.Status, viewingBill.IsOverdue)
                                </span>
                                @if (!string.IsNullOrEmpty(viewingBill.VendorInvoiceNumber))
                                {
                                    <span class="vendor-ref">Ref: @viewingBill.VendorInvoiceNumber</span>
                                }
                            </div>
                            <div class="bill-header-right">
                                <div class="bill-total">
                                    <span class="total-label">Total</span>
                                    <span class="total-value">@viewingBill.Total.ToString("C2")</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bill-info-grid">
                            <div class="info-section">
                                <h4 class="info-title">Vendor</h4>
                                <div class="vendor-info">
                                    <div class="vendor-name">@viewingBill.Vendor.FullName</div>
                                    @if (!string.IsNullOrEmpty(viewingBill.Vendor.Email))
                                    {
                                        <div class="vendor-email">@viewingBill.Vendor.Email</div>
                                    }
                                </div>
                            </div>
                            <div class="info-section">
                                <h4 class="info-title">Dates</h4>
                                <div class="date-info">
                                    <div class="date-row">
                                        <span class="date-label">Bill Date</span>
                                        <span class="date-value">@viewingBill.TransactionDate.ToString("MMM d, yyyy")</span>
                                    </div>
                                    @if (viewingBill.DueDate.HasValue)
                                    {
                                        <div class="date-row @(viewingBill.IsOverdue ? "overdue" : "")">
                                            <span class="date-label">Due Date</span>
                                            <span class="date-value">@viewingBill.DueDate.Value.ToString("MMM d, yyyy")</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="bill-lines-section">
                            <h4 class="section-title">Line Items</h4>
                            <table class="line-items-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Account</th>
                                        <th class="text-right">Qty</th>
                                        <th class="text-right">Cost</th>
                                        <th class="text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var line in viewingBill.Lines)
                                    {
                                        <tr>
                                            <td>
                                                @if (line.Product != null)
                                                {
                                                    <div class="line-product">@line.Product.Name</div>
                                                }
                                                <div class="line-description">@line.Description</div>
                                            </td>
                                            <td class="text-muted">
                                                @(line.Account?.Name ?? "‚Äî")
                                            </td>
                                            <td class="text-right font-mono">@line.Quantity</td>
                                            <td class="text-right font-mono">@line.UnitCost.ToString("C2")</td>
                                            <td class="text-right font-mono">@line.LineTotal.ToString("C2")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            
                            <div class="bill-totals">
                                <div class="totals-row">
                                    <span class="totals-label">Subtotal</span>
                                    <span class="totals-value">@viewingBill.Subtotal.ToString("C2")</span>
                                </div>
                                @if (viewingBill.TaxAmount > 0)
                                {
                                    <div class="totals-row">
                                        <span class="totals-label">Tax</span>
                                        <span class="totals-value">@viewingBill.TaxAmount.ToString("C2")</span>
                                    </div>
                                }
                                <div class="totals-row total">
                                    <span class="totals-label">Total</span>
                                    <span class="totals-value">@viewingBill.Total.ToString("C2")</span>
                                </div>
                                @if (viewingBill.AmountPaid > 0)
                                {
                                    <div class="totals-row paid">
                                        <span class="totals-label">Paid</span>
                                        <span class="totals-value">-@viewingBill.AmountPaid.ToString("C2")</span>
                                    </div>
                                    <div class="totals-row balance">
                                        <span class="totals-label">Balance Due</span>
                                        <span class="totals-value">@viewingBill.BalanceDue.ToString("C2")</span>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(viewingBill.Memo))
                        {
                            <div class="bill-memo">
                                <h4 class="section-title">Memo</h4>
                                <p>@viewingBill.Memo</p>
                            </div>
                        }
                    </ChildContent>
                </Card>
            </div>
            
            @* Right Column - Actions & Status *@
            <div class="bill-detail-sidebar">
                <Card Title="Status">
                    <ChildContent>
                        <div class="status-display">
                            <span class="status-badge @GetStatusBadgeClass(viewingBill.Status, viewingBill.IsOverdue)">
                                @GetStatusDisplay(viewingBill.Status, viewingBill.IsOverdue)
                            </span>
                            @if (viewingBill.IsOverdue)
                            {
                                <div class="overdue-info">
                                    Overdue
                                </div>
                            }
                        </div>
                        
                        <div class="payment-status">
                            <div class="payment-row">
                                <span>Total</span>
                                <span class="font-mono">@viewingBill.Total.ToString("C2")</span>
                            </div>
                            <div class="payment-row">
                                <span>Paid</span>
                                <span class="font-mono text-success">@viewingBill.AmountPaid.ToString("C2")</span>
                            </div>
                            <div class="payment-row balance">
                                <span>Balance</span>
                                <span class="font-mono @(viewingBill.BalanceDue > 0 ? "text-danger" : "text-success")">
                                    @viewingBill.BalanceDue.ToString("C2")
                                </span>
                            </div>
                        </div>
                    </ChildContent>
                </Card>
                
                <Card Title="Actions" CssClass="mt-4">
                    <ChildContent>
                        <div class="quick-actions-vertical">
                            @if (viewingBill.Status == BillStatus.Draft)
                            {
                                <button class="btn btn-primary btn-block" @onclick="() => MarkAsReceived(viewingBill.Id)">
                                    üì• Mark as Received
                                </button>
                                <button class="btn btn-secondary btn-block" @onclick="EditFromView">
                                    ‚úèÔ∏è Edit Bill
                                </button>
                            }
                            @if (viewingBill.Status != BillStatus.Paid && viewingBill.Status != BillStatus.Void)
                            {
                                <button class="btn btn-success btn-block" @onclick="ShowRecordPayment">
                                    üí≥ Pay Bill
                                </button>
                            }
                            @if (viewingBill.Status != BillStatus.Void && viewingBill.Status != BillStatus.Paid)
                            {
                                <button class="btn btn-outline-danger btn-block" @onclick="() => VoidBill(viewingBill.Id)">
                                    üö´ Void Bill
                                </button>
                            }
                        </div>
                    </ChildContent>
                </Card>
                
                @if (viewingBill.PaymentApplications.Any())
                {
                    <Card Title="Payment History" CssClass="mt-4">
                        <ChildContent>
                            <div class="payment-history">
                                @foreach (var payment in viewingBill.PaymentApplications)
                                {
                                    <div class="payment-entry">
                                        <div class="payment-date">@payment.AppliedDate.ToString("MMM d, yyyy")</div>
                                        <div class="payment-amount">@payment.AppliedAmount.ToString("C2")</div>
                                    </div>
                                }
                            </div>
                        </ChildContent>
                    </Card>
                }
            </div>
        </div>
    </div>
    
    @* Record Payment Modal *@
    @if (showPaymentModal)
    {
        <div class="modal-backdrop" @onclick="ClosePaymentModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Pay Bill</h3>
                    <button class="modal-close" @onclick="ClosePaymentModal">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Payment Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" @bind="paymentAmount" step="0.01" />
                        </div>
                        <small class="form-text">Balance due: @viewingBill.BalanceDue.ToString("C2")</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" @bind="paymentDate" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="ClosePaymentModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="RecordPayment">Record Payment</button>
                </div>
            </div>
        </div>
    }
}
else if (isEditing)
{
    @* Bill Form *@
    <div class="bill-form-container">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mb-4">@errorMessage</div>
        }
        
        <Card Title="Bill Details">
            <ChildContent>
                <div class="form-row">
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label">Bill #</label>
                        <input type="text" class="form-control" @bind="editingBill.TransactionNumber" 
                               readonly="@(editingBill.Id > 0)" placeholder="Auto-generated" />
                    </div>
                    <div class="form-group flex-1">
                        <label class="form-label form-label-required">Vendor</label>
                        <select class="form-control" @bind="editingBill.VendorId" @bind:after="OnVendorChanged">
                            <option value="0">-- Select Vendor --</option>
                            @foreach (var vendor in vendors)
                            {
                                <option value="@vendor.Id">@vendor.FullName</option>
                            }
                        </select>
                    </div>
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label">Vendor Ref #</label>
                        <input type="text" class="form-control" @bind="editingBill.VendorInvoiceNumber" 
                               placeholder="Vendor's invoice #" />
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label">Bill Date</label>
                        <input type="date" class="form-control" @bind="editingBill.TransactionDate" />
                    </div>
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" @bind="editingBill.DueDate" />
                    </div>
                    <div class="form-group" style="width: 180px;">
                        <label class="form-label">Received Date</label>
                        <input type="date" class="form-control" @bind="editingBill.ReceivedDate" />
                    </div>
                </div>
            </ChildContent>
        </Card>
        
        <Card Title="Line Items" CssClass="mt-4">
            <ChildContent>
                <table class="line-items-edit-table">
                    <thead>
                        <tr>
                            <th style="width: 200px;">Product/Service</th>
                            <th>Description</th>
                            <th style="width: 180px;">Account</th>
                            <th style="width: 80px;">Qty</th>
                            <th style="width: 120px;">Cost</th>
                            <th style="width: 120px;">Amount</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < editingLines.Count; i++)
                        {
                            var index = i;
                            var line = editingLines[index];
                            <tr>
                                <td>
                                    <select class="form-control form-control-sm" 
                                            value="@line.ProductId"
                                            @onchange="(e) => OnProductSelected(index, e)">
                                        <option value="">-- Select --</option>
                                        @foreach (var product in products)
                                        {
                                            <option value="@product.Id">@product.Name</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" 
                                           @bind="line.Description" placeholder="Description" />
                                </td>
                                <td>
                                    <select class="form-control form-control-sm" @bind="line.AccountId">
                                        <option value="">-- Account --</option>
                                        @foreach (var account in expenseAccounts)
                                        {
                                            <option value="@account.Id">@account.Name</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm text-right" 
                                           @bind="line.Quantity" @bind:after="RecalculateLineTotals" step="0.01" />
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm text-right" 
                                           @bind="line.UnitCost" @bind:after="RecalculateLineTotals" step="0.01" />
                                </td>
                                <td class="text-right font-mono line-total">
                                    @((line.Quantity * line.UnitCost).ToString("C2"))
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveLine(index)">√ó</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                
                <button class="btn btn-secondary btn-sm mt-3" @onclick="AddLine">
                    + Add Line
                </button>
                
                <div class="bill-form-totals">
                    <div class="totals-row">
                        <span>Subtotal</span>
                        <span class="font-mono">@CalculateSubtotal().ToString("C2")</span>
                    </div>
                    <div class="totals-row total">
                        <span>Total</span>
                        <span class="font-mono">@CalculateTotal().ToString("C2")</span>
                    </div>
                </div>
            </ChildContent>
        </Card>
        
        <Card Title="Additional Information" CssClass="mt-4">
            <ChildContent>
                <div class="form-group">
                    <label class="form-label">Memo (internal)</label>
                    <textarea class="form-control" rows="2" @bind="editingBill.Memo" 
                              placeholder="Internal notes"></textarea>
                </div>
            </ChildContent>
        </Card>
        
        <div class="form-actions mt-6">
            <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
            <button type="button" class="btn btn-primary btn-lg" @onclick="SaveBillAsync" disabled="@isSaving">
                @(isSaving ? "Saving..." : (editingBill.Id > 0 ? "Update Bill" : "Create Bill"))
            </button>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
        <button class="btn btn-sm btn-secondary ms-3" @onclick="LoadDataAsync">Retry</button>
    </div>
}
else
{
    @* Bill List *@
    <div class="bills-toolbar">
        <div class="toolbar-left">
            <div class="search-container" style="width: 300px;">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search bills..." 
                       @bind="searchTerm" @bind:event="oninput" />
            </div>
            <select class="form-control" style="width: 150px;" @bind="filterStatus">
                <option value="">All Status</option>
                <option value="Draft">Draft</option>
                <option value="Received">Received</option>
                <option value="Overdue">Overdue</option>
                <option value="PartiallyPaid">Partial</option>
                <option value="Paid">Paid</option>
            </select>
        </div>
    </div>
    
    <div class="bills-summary">
        <div class="summary-card">
            <div class="summary-icon">üìÉ</div>
            <div class="summary-info">
                <div class="summary-label">Total Bills</div>
                <div class="summary-value">@summary.TotalBills</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">üí∏</div>
            <div class="summary-info">
                <div class="summary-label">Outstanding</div>
                <div class="summary-value">@summary.TotalOutstanding.ToString("C2")</div>
            </div>
        </div>
        <div class="summary-card @(summary.OverdueCount > 0 ? "warning" : "")">
            <div class="summary-icon">‚ö†Ô∏è</div>
            <div class="summary-info">
                <div class="summary-label">Overdue</div>
                <div class="summary-value">@summary.TotalOverdue.ToString("C2")</div>
            </div>
        </div>
        <div class="summary-card success">
            <div class="summary-icon">‚úÖ</div>
            <div class="summary-info">
                <div class="summary-label">Paid This Month</div>
                <div class="summary-value">@summary.TotalPaidThisMonth.ToString("C2")</div>
            </div>
        </div>
    </div>

    @if (GetFilteredBills().Any())
    {
        <Card>
            <ChildContent>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Vendor</th>
                            <th>Date</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th class="text-right">Total</th>
                            <th class="text-right">Balance</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bill in GetFilteredBills())
                        {
                            <tr class="cursor-pointer @(bill.IsOverdue ? "overdue-row" : "")" 
                                @onclick="() => ViewBill(bill)">
                                <td class="font-mono">@bill.TransactionNumber</td>
                                <td>
                                    <div class="vendor-name">@bill.Vendor.FullName</div>
                                    @if (!string.IsNullOrEmpty(bill.VendorInvoiceNumber))
                                    {
                                        <div class="vendor-ref-small">Ref: @bill.VendorInvoiceNumber</div>
                                    }
                                </td>
                                <td>@bill.TransactionDate.ToString("MMM d, yyyy")</td>
                                <td class="@(bill.IsOverdue ? "text-danger" : "")">
                                    @(bill.DueDate?.ToString("MMM d, yyyy") ?? "‚Äî")
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(bill.Status, bill.IsOverdue)">
                                        @GetStatusDisplay(bill.Status, bill.IsOverdue)
                                    </span>
                                </td>
                                <td class="text-right font-mono">@bill.Total.ToString("C2")</td>
                                <td class="text-right font-mono @(bill.BalanceDue > 0 ? "text-danger" : "text-success")">
                                    @bill.BalanceDue.ToString("C2")
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" @onclick:stopPropagation="true" 
                                            @onclick="() => ViewBill(bill)">üëÅÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </ChildContent>
        </Card>
    }
    else
    {
        <Card>
            <ChildContent>
                <div class="empty-state">
                    <span class="empty-state-icon">üìÉ</span>
                    <div class="empty-state-title">No bills found</div>
                    <div class="empty-state-description">
                        @if (string.IsNullOrEmpty(searchTerm))
                        {
                            <span>Enter bills from your vendors to track expenses.</span>
                        }
                        else
                        {
                            <span>No bills match your search criteria.</span>
                        }
                    </div>
                    <button class="btn btn-primary" @onclick="CreateNewBill">+ Enter Bill</button>
                </div>
            </ChildContent>
        </Card>
    }
}

<style>
    .bill-form-container, .quick-expense-container { max-width: 1000px; }
    .quick-expense-container { max-width: 600px; }
    
    .bills-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        gap: var(--space-4);
        flex-wrap: wrap;
    }
    
    .toolbar-left {
        display: flex;
        gap: var(--space-3);
        align-items: center;
    }
    
    .bills-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }
    
    .summary-card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        border: 1px solid var(--border-color);
    }
    
    .summary-card.warning { border-color: var(--warning-color); background: var(--warning-light); }
    .summary-card.success { border-color: var(--success-color); background: var(--success-light); }
    
    .summary-icon { font-size: var(--text-2xl); }
    .summary-label { font-size: var(--text-sm); color: var(--text-secondary); }
    .summary-value { font-size: var(--text-xl); font-weight: var(--font-semibold); }
    
    .form-row { display: flex; gap: var(--space-4); flex-wrap: wrap; }
    .form-row .form-group { min-width: 120px; }
    
    .form-actions {
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
        padding-top: var(--space-4);
        border-top: 1px solid var(--border-color);
    }
    
    tr.overdue-row { background: var(--danger-light); }
    .vendor-ref-small { font-size: var(--text-xs); color: var(--text-muted); }
    
    /* Bill Detail Styles */
    .bill-detail-container { max-width: 1200px; }
    
    .bill-detail-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: var(--space-6);
    }
    
    .bill-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: var(--space-4);
        border-bottom: 1px solid var(--border-color);
        margin-bottom: var(--space-4);
    }
    
    .bill-number { margin: 0; font-size: var(--text-2xl); font-family: var(--font-mono); }
    .vendor-ref { display: block; font-size: var(--text-sm); color: var(--text-muted); margin-top: var(--space-2); }
    .bill-total .total-label { display: block; font-size: var(--text-sm); color: var(--text-secondary); }
    .bill-total .total-value { font-size: var(--text-2xl); font-weight: var(--font-bold); }
    
    .bill-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }
    
    .info-section { }
    .info-title { font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--text-secondary); margin-bottom: var(--space-2); }
    .vendor-name { font-weight: var(--font-medium); }
    .vendor-email { font-size: var(--text-sm); color: var(--text-muted); }
    .date-row { display: flex; justify-content: space-between; font-size: var(--text-sm); padding: var(--space-1) 0; }
    .date-row.overdue { color: var(--danger-color); font-weight: var(--font-medium); }
    
    .section-title { font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--text-secondary); margin-bottom: var(--space-3); }
    
    .line-items-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .line-items-table th {
        text-align: left;
        padding: var(--space-2) var(--space-3);
        border-bottom: 2px solid var(--border-color);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--text-secondary);
    }
    
    .line-items-table td {
        padding: var(--space-3);
        border-bottom: 1px solid var(--border-color);
    }
    
    .line-product { font-weight: var(--font-medium); }
    .line-description { font-size: var(--text-sm); color: var(--text-secondary); }
    
    .bill-totals {
        margin-top: var(--space-4);
        padding-top: var(--space-4);
        border-top: 2px solid var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-2);
    }
    
    .totals-row {
        display: flex;
        justify-content: space-between;
        width: 250px;
        padding: var(--space-2);
    }
    
    .totals-row.total { font-weight: var(--font-bold); font-size: var(--text-lg); background: var(--bg-secondary); border-radius: var(--radius-sm); }
    .totals-row.paid { color: var(--success-color); }
    .totals-row.balance { font-weight: var(--font-bold); color: var(--danger-color); }
    
    .bill-memo { margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-color); }
    .bill-memo p { font-size: var(--text-sm); color: var(--text-secondary); }
    
    .status-display { text-align: center; padding: var(--space-4); }
    .status-badge { font-size: var(--text-lg); padding: var(--space-2) var(--space-4); }
    .overdue-info { margin-top: var(--space-2); font-size: var(--text-sm); color: var(--danger-color); }
    
    .payment-status { margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-color); }
    .payment-row { display: flex; justify-content: space-between; padding: var(--space-2) 0; font-size: var(--text-sm); }
    .payment-row.balance { font-weight: var(--font-bold); padding-top: var(--space-3); border-top: 1px solid var(--border-color); }
    
    .payment-history { display: flex; flex-direction: column; gap: var(--space-2); }
    .payment-entry { display: flex; justify-content: space-between; font-size: var(--text-sm); padding: var(--space-2); background: var(--bg-secondary); border-radius: var(--radius-sm); }
    
    .quick-actions-vertical { display: flex; flex-direction: column; gap: var(--space-2); }
    .btn-block { width: 100%; justify-content: center; }
    
    /* Line Items Edit Table */
    .line-items-edit-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .line-items-edit-table th {
        text-align: left;
        padding: var(--space-2);
        border-bottom: 2px solid var(--border-color);
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }
    
    .line-items-edit-table td {
        padding: var(--space-2);
        border-bottom: 1px solid var(--border-color);
        vertical-align: top;
    }
    
    .line-total { padding-top: var(--space-3) !important; }
    
    .bill-form-totals {
        margin-top: var(--space-4);
        padding-top: var(--space-4);
        border-top: 2px solid var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-2);
    }
    
    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 400px;
        box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h3 { margin: 0; }
    .modal-close { background: none; border: none; font-size: var(--text-2xl); cursor: pointer; color: var(--text-muted); }
    
    .modal-body { padding: var(--space-4); }
    
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        padding: var(--space-4);
        border-top: 1px solid var(--border-color);
    }
    
    @@media (max-width: 900px) {
        .bill-detail-grid { grid-template-columns: 1fr; }
        .bill-info-grid { grid-template-columns: 1fr; }
    }
</style>

@code {
    [Parameter]
    public int? BillId { get; set; }
    
    private List<Bill> bills = new();
    private List<Vendor> vendors = new();
    private List<Product> products = new();
    private List<Account> expenseAccounts = new();
    private Bill editingBill = new();
    private Bill? viewingBill;
    private List<BillLine> editingLines = new();
    private BillSummary summary = new();
    private bool isLoading = true;
    private bool isEditing = false;
    private bool isViewing = false;
    private bool isSaving = false;
    private bool showQuickExpense = false;
    private string searchTerm = "";
    private string filterStatus = "";
    private string? errorMessage;
    
    // Quick expense
    private QuickExpenseModel quickExpense = new();
    
    // Payment modal
    private bool showPaymentModal = false;
    private decimal paymentAmount = 0;
    private DateTime paymentDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (uri.AbsolutePath.EndsWith("/new", StringComparison.OrdinalIgnoreCase))
        {
            CreateNewBill();
        }
        else if (BillId.HasValue && BillId.Value > 0)
        {
            var bill = await BillService.GetByIdWithDetailsAsync(BillId.Value);
            if (bill != null)
            {
                ViewBill(bill);
            }
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            bills = (await BillService.GetAllWithDetailsAsync()).ToList();
            vendors = (await VendorService.GetActiveVendorsAsync()).ToList();
            products = (await ProductService.GetPurchasableProductsAsync()).ToList();
            expenseAccounts = (await BillService.GetExpenseAccountsAsync()).ToList();
            summary = await BillService.GetBillSummaryAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<Bill> GetFilteredBills()
    {
        var filtered = bills.AsEnumerable();
        
        if (!string.IsNullOrEmpty(filterStatus))
        {
            if (filterStatus == "Overdue")
            {
                filtered = filtered.Where(b => b.IsOverdue);
            }
            else if (Enum.TryParse<BillStatus>(filterStatus, out var status))
            {
                filtered = filtered.Where(b => b.Status == status);
            }
        }
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filtered = filtered.Where(b =>
                b.TransactionNumber.ToLower().Contains(term) ||
                b.Vendor.Name.ToLower().Contains(term) ||
                (b.VendorInvoiceNumber?.ToLower().Contains(term) ?? false));
        }
        
        return filtered;
    }

    private void CreateNewBill()
    {
        editingBill = new Bill
        {
            TransactionDate = DateTime.Today,
            DueDate = DateTime.Today.AddDays(30),
            ReceivedDate = DateTime.Today,
            Status = BillStatus.Draft
        };
        editingLines = new List<BillLine> { new BillLine { Quantity = 1 } };
        isEditing = true;
        isViewing = false;
        showQuickExpense = false;
        viewingBill = null;
        errorMessage = null;
    }

    private void ShowQuickExpenseForm()
    {
        quickExpense = new QuickExpenseModel
        {
            Date = DateTime.Today
        };
        showQuickExpense = true;
        isEditing = false;
        isViewing = false;
        errorMessage = null;
    }

    private void CancelQuickExpense()
    {
        showQuickExpense = false;
        errorMessage = null;
    }

    private async Task SaveQuickExpense()
    {
        if (quickExpense.VendorId == 0)
        {
            errorMessage = "Please select a vendor";
            return;
        }
        if (quickExpense.AccountId == 0)
        {
            errorMessage = "Please select an expense category";
            return;
        }
        if (quickExpense.Amount <= 0)
        {
            errorMessage = "Please enter an amount";
            return;
        }
        
        isSaving = true;
        errorMessage = null;
        
        try
        {
            await BillService.CreateQuickExpenseAsync(
                quickExpense.VendorId,
                quickExpense.AccountId,
                quickExpense.Amount,
                quickExpense.Description ?? "",
                quickExpense.Date
            );
            
            await LoadDataAsync();
            showQuickExpense = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving expense: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ViewBill(Bill bill)
    {
        viewingBill = bill;
        isViewing = true;
        isEditing = false;
        showQuickExpense = false;
    }

    private void EditFromView()
    {
        if (viewingBill == null) return;
        
        editingBill = new Bill
        {
            Id = viewingBill.Id,
            TransactionNumber = viewingBill.TransactionNumber,
            VendorId = viewingBill.VendorId,
            TransactionDate = viewingBill.TransactionDate,
            DueDate = viewingBill.DueDate,
            ReceivedDate = viewingBill.ReceivedDate,
            VendorInvoiceNumber = viewingBill.VendorInvoiceNumber,
            Memo = viewingBill.Memo,
            TaxAmount = viewingBill.TaxAmount,
            DiscountAmount = viewingBill.DiscountAmount,
            Status = viewingBill.Status
        };
        
        editingLines = viewingBill.Lines.Select(l => new BillLine
        {
            Id = l.Id,
            ProductId = l.ProductId,
            Description = l.Description,
            AccountId = l.AccountId,
            Quantity = l.Quantity,
            UnitCost = l.UnitCost,
            IsBillable = l.IsBillable,
            CustomerId = l.CustomerId,
            SortOrder = l.SortOrder
        }).ToList();
        
        if (!editingLines.Any())
        {
            editingLines.Add(new BillLine { Quantity = 1 });
        }
        
        isEditing = true;
        isViewing = false;
        errorMessage = null;
    }

    private void BackToList()
    {
        isViewing = false;
        isEditing = false;
        showQuickExpense = false;
        viewingBill = null;
        Navigation.NavigateTo("/bills");
    }

    private void CancelEdit()
    {
        if (viewingBill != null)
        {
            isEditing = false;
            isViewing = true;
        }
        else
        {
            isEditing = false;
            Navigation.NavigateTo("/bills");
        }
    }

    private void OnVendorChanged()
    {
        var vendor = vendors.FirstOrDefault(v => v.Id == editingBill.VendorId);
        if (vendor != null)
        {
            editingBill.DueDate = DateTime.Today.AddDays(vendor.PaymentTermsDays);
        }
    }

    private void OnProductSelected(int lineIndex, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int productId))
        {
            var product = products.FirstOrDefault(p => p.Id == productId);
            if (product != null && lineIndex < editingLines.Count)
            {
                editingLines[lineIndex].ProductId = productId;
                editingLines[lineIndex].Description = product.PurchaseDescription ?? product.Name;
                editingLines[lineIndex].UnitCost = product.PurchaseCost;
                editingLines[lineIndex].AccountId = product.ExpenseAccountId;
                StateHasChanged();
            }
        }
        else
        {
            editingLines[lineIndex].ProductId = null;
        }
    }

    private void AddLine()
    {
        editingLines.Add(new BillLine { Quantity = 1 });
    }

    private void RemoveLine(int index)
    {
        if (editingLines.Count > 1)
        {
            editingLines.RemoveAt(index);
        }
    }

    private void RecalculateLineTotals()
    {
        StateHasChanged();
    }

    private decimal CalculateSubtotal() => editingLines.Sum(l => l.Quantity * l.UnitCost);
    private decimal CalculateTotal() => CalculateSubtotal() + editingBill.TaxAmount - editingBill.DiscountAmount;

    private async Task SaveBillAsync()
    {
        if (editingBill.VendorId == 0)
        {
            errorMessage = "Please select a vendor";
            return;
        }
        
        if (!editingLines.Any(l => l.Quantity > 0 && l.UnitCost > 0))
        {
            errorMessage = "Please add at least one line item";
            return;
        }
        
        isSaving = true;
        errorMessage = null;
        
        try
        {
            var linesToSave = editingLines
                .Where(l => l.Quantity > 0 || !string.IsNullOrEmpty(l.Description))
                .ToList();
            
            Bill saved;
            if (editingBill.Id > 0)
            {
                saved = await BillService.UpdateWithLinesAsync(editingBill, linesToSave);
            }
            else
            {
                saved = await BillService.CreateWithLinesAsync(editingBill, linesToSave);
            }
            
            await LoadDataAsync();
            
            var updatedBill = await BillService.GetByIdWithDetailsAsync(saved.Id);
            if (updatedBill != null)
            {
                ViewBill(updatedBill);
            }
            else
            {
                BackToList();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving bill: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task MarkAsReceived(int billId)
    {
        await BillService.UpdateStatusAsync(billId, BillStatus.Received);
        await LoadDataAsync();
        var updated = await BillService.GetByIdWithDetailsAsync(billId);
        if (updated != null) ViewBill(updated);
    }

    private async Task VoidBill(int billId)
    {
        await BillService.VoidBillAsync(billId);
        await LoadDataAsync();
        BackToList();
    }

    private void ShowRecordPayment()
    {
        if (viewingBill == null) return;
        paymentAmount = viewingBill.BalanceDue;
        paymentDate = DateTime.Today;
        showPaymentModal = true;
    }

    private void ClosePaymentModal()
    {
        showPaymentModal = false;
    }

    private async Task RecordPayment()
    {
        if (viewingBill == null || paymentAmount <= 0) return;
        
        await BillService.ApplyPaymentAsync(viewingBill.Id, paymentAmount, 0);
        
        showPaymentModal = false;
        await LoadDataAsync();
        var updated = await BillService.GetByIdWithDetailsAsync(viewingBill.Id);
        if (updated != null) ViewBill(updated);
    }

    private string GetStatusBadgeClass(BillStatus status, bool isOverdue)
    {
        if (isOverdue) return "badge-danger";
        return status switch
        {
            BillStatus.Draft => "badge-secondary",
            BillStatus.Received => "badge-info",
            BillStatus.PartiallyPaid => "badge-warning",
            BillStatus.Paid => "badge-success",
            BillStatus.Void => "badge-secondary",
            _ => "badge-secondary"
        };
    }

    private string GetStatusDisplay(BillStatus status, bool isOverdue)
    {
        if (isOverdue) return "Overdue";
        return status switch
        {
            BillStatus.Draft => "Draft",
            BillStatus.Received => "Received",
            BillStatus.PartiallyPaid => "Partial",
            BillStatus.Paid => "Paid",
            BillStatus.Void => "Void",
            _ => "Unknown"
        };
    }

    private string GetPageTitle()
    {
        if (showQuickExpense)
            return "Quick Expense";
        if (isEditing)
            return editingBill.Id > 0 ? "Edit Bill" : "New Bill";
        if (isViewing && viewingBill != null)
            return viewingBill.TransactionNumber;
        return "Bills & Expenses";
    }

    private string GetPageSubtitle()
    {
        if (showQuickExpense)
            return "Record an expense quickly";
        if (isEditing)
            return editingBill.Id > 0 ? $"Editing {editingBill.TransactionNumber}" : "Enter a new bill from a vendor";
        if (isViewing && viewingBill != null)
            return viewingBill.Vendor.FullName;
        return "Track bills and expenses from vendors";
    }

    private class QuickExpenseModel
    {
        public int VendorId { get; set; }
        public int AccountId { get; set; }
        public decimal Amount { get; set; }
        public string? Description { get; set; }
        public DateTime Date { get; set; } = DateTime.Today;
    }
}
