@page "/customers"
@page "/customers/new"
@page "/customers/{CustomerId:int}"
@inject ICustomerService CustomerService
@inject NavigationManager Navigation

<PageHeader Title="@GetPageTitle()" Subtitle="@GetPageSubtitle()">
    <ActionContent>
        @if (isViewing && viewingCustomer != null)
        {
            <button class="btn btn-secondary" @onclick="BackToList">
                ‚Üê Back
            </button>
            <button class="btn btn-primary" @onclick="EditFromView">
                ‚úèÔ∏è Edit
            </button>
        }
        else if (!isEditing)
        {
            <button class="btn btn-primary" @onclick="CreateNewCustomer">
                + New Customer
            </button>
        }
    </ActionContent>
</PageHeader>

@if (isLoading)
{
    <LoadingSpinner Text="Loading..." />
}
else if (isViewing && viewingCustomer != null)
{
    @* Customer Detail View *@
    <div class="customer-detail-container">
        <div class="customer-detail-grid">
            @* Left Column - Customer Info *@
            <div class="customer-detail-main">
                <Card Title="Customer Information">
                    <ChildContent>
                        <div class="detail-header">
                            <div class="customer-avatar-lg">@viewingCustomer.Initials</div>
                            <div class="detail-header-info">
                                <h2 class="detail-name">@viewingCustomer.FullName</h2>
                                @if (!string.IsNullOrEmpty(viewingCustomer.CompanyName) && viewingCustomer.CompanyName != viewingCustomer.Name)
                                {
                                    <div class="detail-company">@viewingCustomer.CompanyName</div>
                                }
                                <div class="detail-number">@viewingCustomer.CustomerNumber</div>
                            </div>
                            <div class="detail-status">
                                @if (viewingCustomer.IsActive)
                                {
                                    <span class="badge badge-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">Inactive</span>
                                }
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4 class="detail-section-title">Contact Information</h4>
                            <div class="detail-grid">
                                @if (!string.IsNullOrEmpty(viewingCustomer.Email))
                                {
                                    <div class="detail-item">
                                        <span class="detail-label">üìß Email</span>
                                        <span class="detail-value">@viewingCustomer.Email</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(viewingCustomer.Phone))
                                {
                                    <div class="detail-item">
                                        <span class="detail-label">üìû Phone</span>
                                        <span class="detail-value">@viewingCustomer.Phone</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(viewingCustomer.Mobile))
                                {
                                    <div class="detail-item">
                                        <span class="detail-label">üì± Mobile</span>
                                        <span class="detail-value">@viewingCustomer.Mobile</span>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(viewingCustomer.Website))
                                {
                                    <div class="detail-item">
                                        <span class="detail-label">üåê Website</span>
                                        <span class="detail-value">@viewingCustomer.Website</span>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(viewingCustomer.BillingAddressFull))
                        {
                            <div class="detail-section">
                                <h4 class="detail-section-title">Billing Address</h4>
                                <div class="detail-address">
                                    @if (!string.IsNullOrEmpty(viewingCustomer.BillingAddress1))
                                    {
                                        <div>@viewingCustomer.BillingAddress1</div>
                                    }
                                    @if (!string.IsNullOrEmpty(viewingCustomer.BillingAddress2))
                                    {
                                        <div>@viewingCustomer.BillingAddress2</div>
                                    }
                                    <div>@viewingCustomer.BillingCity, @viewingCustomer.BillingState @viewingCustomer.BillingPostalCode</div>
                                    @if (!string.IsNullOrEmpty(viewingCustomer.BillingCountry))
                                    {
                                        <div>@viewingCustomer.BillingCountry</div>
                                    }
                                </div>
                            </div>
                        }
                        
                        @if (!viewingCustomer.ShippingSameAsBilling && !string.IsNullOrEmpty(viewingCustomer.ShippingAddressFull))
                        {
                            <div class="detail-section">
                                <h4 class="detail-section-title">Shipping Address</h4>
                                <div class="detail-address">
                                    @if (!string.IsNullOrEmpty(viewingCustomer.ShippingAddress1))
                                    {
                                        <div>@viewingCustomer.ShippingAddress1</div>
                                    }
                                    @if (!string.IsNullOrEmpty(viewingCustomer.ShippingAddress2))
                                    {
                                        <div>@viewingCustomer.ShippingAddress2</div>
                                    }
                                    <div>@viewingCustomer.ShippingCity, @viewingCustomer.ShippingState @viewingCustomer.ShippingPostalCode</div>
                                </div>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(viewingCustomer.Notes))
                        {
                            <div class="detail-section">
                                <h4 class="detail-section-title">Notes</h4>
                                <div class="detail-notes">@viewingCustomer.Notes</div>
                            </div>
                        }
                    </ChildContent>
                </Card>
            </div>
            
            @* Right Column - Financial Info *@
            <div class="customer-detail-sidebar">
                <Card Title="Balance Summary">
                    <ChildContent>
                        <div class="financial-stat primary">
                            <span class="financial-label">Current Balance</span>
                            <span class="financial-value @(balanceSummary.CurrentBalance > 0 ? "text-danger" : "text-success")">
                                @balanceSummary.CurrentBalance.ToString("C2")
                            </span>
                        </div>
                        
                        @if (balanceSummary.OverdueAmount > 0)
                        {
                            <div class="overdue-warning">
                                <span class="overdue-icon">‚ö†Ô∏è</span>
                                <div class="overdue-info">
                                    <span class="overdue-label">Overdue</span>
                                    <span class="overdue-value">@balanceSummary.OverdueAmount.ToString("C2")</span>
                                </div>
                            </div>
                        }
                        
                        <div class="balance-stats">
                            <div class="balance-stat-row">
                                <span class="balance-stat-label">Total Invoiced</span>
                                <span class="balance-stat-value">@balanceSummary.TotalInvoiced.ToString("C2")</span>
                            </div>
                            <div class="balance-stat-row">
                                <span class="balance-stat-label">Total Payments</span>
                                <span class="balance-stat-value text-success">@balanceSummary.TotalPayments.ToString("C2")</span>
                            </div>
                            <div class="balance-stat-row">
                                <span class="balance-stat-label">Open Invoices</span>
                                <span class="balance-stat-value">@balanceSummary.OpenInvoices</span>
                            </div>
                            @if (balanceSummary.OverdueInvoices > 0)
                            {
                                <div class="balance-stat-row">
                                    <span class="balance-stat-label">Overdue Invoices</span>
                                    <span class="balance-stat-value text-danger">@balanceSummary.OverdueInvoices</span>
                                </div>
                            }
                        </div>
                        
                        @if (balanceSummary.LastPaymentDate.HasValue)
                        {
                            <div class="last-payment">
                                <span class="last-payment-label">Last Payment</span>
                                <div class="last-payment-info">
                                    <span class="last-payment-amount">@balanceSummary.LastPaymentAmount.ToString("C2")</span>
                                    <span class="last-payment-date">on @balanceSummary.LastPaymentDate.Value.ToString("MMM d, yyyy")</span>
                                </div>
                            </div>
                        }
                        
                        <div class="financial-details mt-4">
                            <div class="financial-row">
                                <span class="financial-label">Payment Terms</span>
                                <span class="financial-value">@viewingCustomer.PaymentTerms</span>
                            </div>
                            <div class="financial-row">
                                <span class="financial-label">Credit Limit</span>
                                <span class="financial-value">@viewingCustomer.CreditLimit.ToString("C2")</span>
                            </div>
                        </div>
                    </ChildContent>
                </Card>
                
                <Card Title="Quick Actions" CssClass="mt-4">
                    <ChildContent>
                        <div class="quick-actions-vertical">
                            <button class="btn btn-secondary btn-block" @onclick="EditFromView">
                                ‚úèÔ∏è Edit Customer
                            </button>
                            @* Placeholder for future invoice/transaction features *@
                            <button class="btn btn-secondary btn-block" disabled title="Coming soon">
                                üìÑ Create Invoice
                            </button>
                            <button class="btn btn-secondary btn-block" disabled title="Coming soon">
                                üí≥ Receive Payment
                            </button>
                        </div>
                    </ChildContent>
                </Card>
            </div>
        </div>
        
        @* Transaction History Section *@
        <Card Title="Transaction History" CssClass="mt-4">
            <ChildContent>
                @if (customerTransactions.Any())
                {
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Transaction</th>
                                <th>Date</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var txn in customerTransactions)
                            {
                                <tr class="@(txn.IsCredit ? "txn-credit" : "")">
                                    <td class="txn-icon">@txn.TypeIcon</td>
                                    <td>
                                        <div class="txn-number">@txn.TransactionNumber</div>
                                        <div class="txn-type">@txn.Type</div>
                                    </td>
                                    <td>@txn.Date.ToString("MMM d, yyyy")</td>
                                    <td>
                                        @if (txn.DueDate.HasValue)
                                        {
                                            <span>@txn.DueDate.Value.ToString("MMM d, yyyy")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">‚Äî</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @txn.StatusClass">@txn.Status</span>
                                    </td>
                                    <td class="text-right font-mono @(txn.IsCredit ? "text-success" : "")">
                                        @(txn.IsCredit ? "-" : "")@txn.Amount.ToString("C2")
                                    </td>
                                    <td class="text-right font-mono @(txn.Balance > 0 ? "text-danger" : "")">
                                        @if (txn.IsCredit)
                                        {
                                            <span class="text-muted">‚Äî</span>
                                        }
                                        else
                                        {
                                            @txn.Balance.ToString("C2")
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="empty-state-sm">
                        <span class="empty-icon">üìã</span>
                        <span class="empty-text">No transactions yet</span>
                        <span class="empty-hint">Invoices and payments will appear here</span>
                    </div>
                }
                
                <div class="customer-dates mt-4">
                    <div class="date-row">
                        <span class="date-label">Customer Since</span>
                        <span class="date-value">@viewingCustomer.CreatedAt.ToString("MMM d, yyyy")</span>
                    </div>
                    @if (viewingCustomer.UpdatedAt.HasValue && viewingCustomer.UpdatedAt != viewingCustomer.CreatedAt)
                    {
                        <div class="date-row">
                            <span class="date-label">Last Updated</span>
                            <span class="date-value">@viewingCustomer.UpdatedAt.Value.ToString("MMM d, yyyy")</span>
                        </div>
                    }
                </div>
            </ChildContent>
        </Card>
    </div>
}
else if (isEditing && editingCustomer != null)
{
    @* Customer Form *@
    <div class="customer-form-container">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mb-4">@errorMessage</div>
        }
        
        <EditForm Model="editingCustomer" OnValidSubmit="SaveCustomerAsync">
            <DataAnnotationsValidator />
            
            <Card Title="Basic Information">
                <ChildContent>
                    <div class="form-row">
                        <div class="form-group" style="width: 150px;">
                            <label class="form-label">Customer #</label>
                            <InputText @bind-Value="editingCustomer.CustomerNumber" class="form-control" 
                                       readonly="@(editingCustomer.Id > 0)" placeholder="Auto-generated" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label form-label-required">Name</label>
                            <InputText @bind-Value="editingCustomer.Name" class="form-control" placeholder="Customer name" />
                            <ValidationMessage For="() => editingCustomer.Name" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Company Name</label>
                            <InputText @bind-Value="editingCustomer.CompanyName" class="form-control" placeholder="Company name (optional)" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Display Name</label>
                            <InputText @bind-Value="editingCustomer.DisplayName" class="form-control" placeholder="How name appears on invoices" />
                        </div>
                    </div>
                </ChildContent>
            </Card>
            
            <Card Title="Contact Information" CssClass="mt-4">
                <ChildContent>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">First Name</label>
                            <InputText @bind-Value="editingCustomer.FirstName" class="form-control" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Last Name</label>
                            <InputText @bind-Value="editingCustomer.LastName" class="form-control" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Email</label>
                            <InputText @bind-Value="editingCustomer.Email" class="form-control" type="email" placeholder="email@example.com" />
                            <ValidationMessage For="() => editingCustomer.Email" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Website</label>
                            <InputText @bind-Value="editingCustomer.Website" class="form-control" placeholder="https://" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Phone</label>
                            <InputText @bind-Value="editingCustomer.Phone" class="form-control" placeholder="(555) 555-5555" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Mobile</label>
                            <InputText @bind-Value="editingCustomer.Mobile" class="form-control" placeholder="(555) 555-5555" />
                        </div>
                    </div>
                </ChildContent>
            </Card>
            
            <Card Title="Billing Address" CssClass="mt-4">
                <ChildContent>
                    <div class="form-group">
                        <label class="form-label">Address Line 1</label>
                        <InputText @bind-Value="editingCustomer.BillingAddress1" class="form-control" placeholder="Street address" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address Line 2</label>
                        <InputText @bind-Value="editingCustomer.BillingAddress2" class="form-control" placeholder="Suite, unit, etc." />
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">City</label>
                            <InputText @bind-Value="editingCustomer.BillingCity" class="form-control" />
                        </div>
                        <div class="form-group" style="width: 120px;">
                            <label class="form-label">State</label>
                            <InputText @bind-Value="editingCustomer.BillingState" class="form-control" />
                        </div>
                        <div class="form-group" style="width: 120px;">
                            <label class="form-label">ZIP</label>
                            <InputText @bind-Value="editingCustomer.BillingPostalCode" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group" style="max-width: 300px;">
                        <label class="form-label">Country</label>
                        <InputText @bind-Value="editingCustomer.BillingCountry" class="form-control" />
                    </div>
                </ChildContent>
            </Card>
            
            <Card Title="Shipping Address" CssClass="mt-4">
                <ChildContent>
                    <div class="form-check mb-4">
                        <InputCheckbox @bind-Value="editingCustomer.ShippingSameAsBilling" class="form-check-input" id="sameAsBilling" />
                        <label class="form-check-label" for="sameAsBilling">Same as billing address</label>
                    </div>
                    
                    @if (!editingCustomer.ShippingSameAsBilling)
                    {
                        <div class="form-group">
                            <label class="form-label">Address Line 1</label>
                            <InputText @bind-Value="editingCustomer.ShippingAddress1" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address Line 2</label>
                            <InputText @bind-Value="editingCustomer.ShippingAddress2" class="form-control" />
                        </div>
                        <div class="form-row">
                            <div class="form-group flex-1">
                                <label class="form-label">City</label>
                                <InputText @bind-Value="editingCustomer.ShippingCity" class="form-control" />
                            </div>
                            <div class="form-group" style="width: 120px;">
                                <label class="form-label">State</label>
                                <InputText @bind-Value="editingCustomer.ShippingState" class="form-control" />
                            </div>
                            <div class="form-group" style="width: 120px;">
                                <label class="form-label">ZIP</label>
                                <InputText @bind-Value="editingCustomer.ShippingPostalCode" class="form-control" />
                            </div>
                        </div>
                    }
                </ChildContent>
            </Card>
            
            <Card Title="Payment & Tax Settings" CssClass="mt-4">
                <ChildContent>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Payment Terms</label>
                            <InputSelect @bind-Value="editingCustomer.PaymentTermsDays" class="form-control">
                                <option value="0">Due on Receipt</option>
                                <option value="7">Net 7</option>
                                <option value="10">Net 10</option>
                                <option value="15">Net 15</option>
                                <option value="30">Net 30</option>
                                <option value="45">Net 45</option>
                                <option value="60">Net 60</option>
                                <option value="90">Net 90</option>
                            </InputSelect>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Credit Limit</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <InputNumber @bind-Value="editingCustomer.CreditLimit" class="form-control" />
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div class="form-check mt-4">
                                <InputCheckbox @bind-Value="editingCustomer.IsTaxExempt" class="form-check-input" id="taxExempt" />
                                <label class="form-check-label" for="taxExempt">Tax Exempt</label>
                            </div>
                        </div>
                        @if (editingCustomer.IsTaxExempt)
                        {
                            <div class="form-group flex-1">
                                <label class="form-label">Tax Exempt Number</label>
                                <InputText @bind-Value="editingCustomer.TaxExemptNumber" class="form-control" />
                            </div>
                        }
                    </div>
                </ChildContent>
            </Card>
            
            <Card Title="Additional Information" CssClass="mt-4">
                <ChildContent>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="editingCustomer.Notes" class="form-control" rows="3" 
                                       placeholder="Internal notes about this customer" />
                    </div>
                    
                    @if (editingCustomer.Id > 0)
                    {
                        <div class="form-check mt-4">
                            <InputCheckbox @bind-Value="editingCustomer.IsActive" class="form-check-input" id="isActive" />
                            <label class="form-check-label" for="isActive">Customer is active</label>
                        </div>
                    }
                </ChildContent>
            </Card>
            
            <div class="form-actions mt-6">
                <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                <button type="submit" class="btn btn-primary btn-lg" disabled="@isSaving">
                    @(isSaving ? "Saving..." : "Save Customer")
                </button>
            </div>
        </EditForm>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
        <button class="btn btn-sm btn-secondary ms-3" @onclick="LoadCustomersAsync">Retry</button>
    </div>
}
else
{
    @* Customer List *@
    <div class="customers-toolbar">
        <div class="search-container" style="max-width: 400px;">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" placeholder="Search customers..." 
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
        </div>
        <label class="form-check" style="margin: 0;">
            <input type="checkbox" class="form-check-input" @bind="showInactive" @bind:after="LoadCustomersAsync" />
            <span class="form-check-label">Show Inactive</span>
        </label>
    </div>
    
    <div class="customers-summary">
        <div class="summary-card">
            <div class="summary-icon">üë•</div>
            <div class="summary-info">
                <div class="summary-label">Total Customers</div>
                <div class="summary-value">@customers.Count(c => c.IsActive)</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">üí∞</div>
            <div class="summary-info">
                <div class="summary-label">Total Receivables</div>
                <div class="summary-value">@customers.Where(c => c.Balance > 0).Sum(c => c.Balance).ToString("C2")</div>
            </div>
        </div>
        <div class="summary-card">
            <div class="summary-icon">‚ö†Ô∏è</div>
            <div class="summary-info">
                <div class="summary-label">With Balance</div>
                <div class="summary-value">@customers.Count(c => c.Balance > 0)</div>
            </div>
        </div>
    </div>

    @if (GetFilteredCustomers().Any())
    {
        <Card>
            <ChildContent>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Customer</th>
                            <th>Contact</th>
                            <th>Phone</th>
                            <th class="text-right">Balance</th>
                            <th style="width: 100px;">Status</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var customer in GetFilteredCustomers())
                        {
                            <tr class="@(customer.IsActive ? "" : "inactive") cursor-pointer" @onclick="async () => await ViewCustomerAsync(customer)">
                                <td>
                                    <div class="customer-avatar">@customer.Initials</div>
                                </td>
                                <td>
                                    <div class="customer-name">@customer.FullName</div>
                                    @if (!string.IsNullOrEmpty(customer.CompanyName) && customer.CompanyName != customer.Name)
                                    {
                                        <div class="customer-company">@customer.CompanyName</div>
                                    }
                                    <div class="customer-number">@customer.CustomerNumber</div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(customer.Email))
                                    {
                                        <div class="customer-email">@customer.Email</div>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(customer.Phone))
                                    {
                                        <span>@customer.Phone</span>
                                    }
                                </td>
                                <td class="text-right font-mono @(customer.Balance > 0 ? "text-danger" : "")">
                                    @customer.Balance.ToString("C2")
                                </td>
                                <td>
                                    @if (customer.IsActive)
                                    {
                                        <span class="badge badge-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-secondary">Inactive</span>
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" @onclick:stopPropagation="true" 
                                            @onclick="() => EditCustomer(customer)">‚úèÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </ChildContent>
        </Card>
    }
    else
    {
        <Card>
            <ChildContent>
                <div class="empty-state">
                    <span class="empty-state-icon">üë•</span>
                    <div class="empty-state-title">No customers found</div>
                    <div class="empty-state-description">
                        @if (string.IsNullOrEmpty(searchTerm))
                        {
                            <span>Add your first customer to start tracking sales and receivables.</span>
                        }
                        else
                        {
                            <span>No customers match your search criteria.</span>
                        }
                    </div>
                    <button class="btn btn-primary" @onclick="CreateNewCustomer">+ Add Customer</button>
                </div>
            </ChildContent>
        </Card>
    }
}

<style>
    /* Customer Detail View Styles */
    .customer-detail-container {
        max-width: 1200px;
    }
    
    .customer-detail-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: var(--space-6);
    }
    
    .customer-detail-main { }
    .customer-detail-sidebar { }
    
    .detail-header {
        display: flex;
        align-items: flex-start;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
        padding-bottom: var(--space-4);
        border-bottom: 1px solid var(--border-color);
    }
    
    .customer-avatar-lg {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-full);
        background: var(--primary-light);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-bold);
        font-size: var(--text-xl);
        flex-shrink: 0;
    }
    
    .detail-header-info { flex: 1; }
    .detail-name { margin: 0 0 var(--space-1) 0; font-size: var(--text-xl); font-weight: var(--font-semibold); }
    .detail-company { color: var(--text-secondary); font-size: var(--text-sm); }
    .detail-number { color: var(--text-muted); font-size: var(--text-sm); font-family: var(--font-mono); }
    
    .detail-section {
        margin-bottom: var(--space-5);
    }
    
    .detail-section-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-3);
        padding-bottom: var(--space-2);
        border-bottom: 1px solid var(--border-color);
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }
    
    .detail-label {
        font-size: var(--text-xs);
        color: var(--text-muted);
    }
    
    .detail-value {
        font-size: var(--text-sm);
        color: var(--text-primary);
    }
    
    .detail-address {
        font-size: var(--text-sm);
        color: var(--text-primary);
        line-height: 1.6;
    }
    
    .detail-notes {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        white-space: pre-wrap;
        background: var(--bg-secondary);
        padding: var(--space-3);
        border-radius: var(--radius-md);
    }
    
    .financial-stat.primary {
        text-align: center;
        padding: var(--space-4);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
    }
    
    .financial-stat .financial-label {
        display: block;
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: var(--space-1);
    }
    
    .financial-stat .financial-value {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        font-family: var(--font-mono);
    }
    
    .financial-details {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .financial-row {
        display: flex;
        justify-content: space-between;
        padding: var(--space-2) 0;
        border-bottom: 1px solid var(--border-color);
        font-size: var(--text-sm);
    }
    
    .financial-row:last-child { border-bottom: none; }
    .financial-row .financial-label { color: var(--text-secondary); }
    .financial-row .financial-value { font-weight: var(--font-medium); }
    
    .quick-actions-vertical {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .btn-block { width: 100%; justify-content: center; }
    
    .activity-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-4);
        color: var(--text-muted);
        text-align: center;
    }
    
    .activity-placeholder .activity-icon { font-size: var(--text-2xl); opacity: 0.5; }
    .activity-placeholder .activity-text { font-size: var(--text-sm); }
    
    .customer-dates {
        margin-top: var(--space-4);
        padding-top: var(--space-4);
        border-top: 1px solid var(--border-color);
    }
    
    .date-row {
        display: flex;
        justify-content: space-between;
        font-size: var(--text-xs);
        color: var(--text-muted);
        padding: var(--space-1) 0;
    }
    
    @@media (max-width: 900px) {
        .customer-detail-grid {
            grid-template-columns: 1fr;
        }
        .detail-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Balance Tracking Styles */
    .overdue-warning {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-3);
        background: var(--danger-light);
        border: 1px solid var(--danger-color);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-4);
    }
    
    .overdue-icon { font-size: var(--text-lg); }
    .overdue-info { display: flex; flex-direction: column; }
    .overdue-label { font-size: var(--text-xs); color: var(--danger-color); font-weight: var(--font-semibold); }
    .overdue-value { font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--danger-color); }
    
    .balance-stats {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
    }
    
    .balance-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-2);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
    }
    
    .balance-stat-label { color: var(--text-secondary); }
    .balance-stat-value { font-weight: var(--font-medium); font-family: var(--font-mono); }
    
    .last-payment {
        padding: var(--space-3);
        background: var(--success-light);
        border-radius: var(--radius-md);
        border: 1px solid var(--success-color);
    }
    
    .last-payment-label { font-size: var(--text-xs); color: var(--success-dark); display: block; margin-bottom: var(--space-1); }
    .last-payment-info { display: flex; align-items: baseline; gap: var(--space-2); }
    .last-payment-amount { font-weight: var(--font-bold); color: var(--success-color); }
    .last-payment-date { font-size: var(--text-sm); color: var(--text-muted); }
    
    /* Transaction History Styles */
    .txn-icon { font-size: var(--text-lg); text-align: center; }
    .txn-number { font-weight: var(--font-medium); font-family: var(--font-mono); font-size: var(--text-sm); }
    .txn-type { font-size: var(--text-xs); color: var(--text-muted); }
    .txn-credit { background: var(--success-light); }
    
    .empty-state-sm {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-6);
        color: var(--text-muted);
        text-align: center;
    }
    
    .empty-icon { font-size: var(--text-3xl); opacity: 0.5; }
    .empty-text { font-weight: var(--font-medium); }
    .empty-hint { font-size: var(--text-sm); }
    
    /* End Customer Detail View Styles */
    
    .customer-form-container {
        max-width: 800px;
    }
    
    .customers-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
        gap: var(--space-4);
        flex-wrap: wrap;
    }
    
    .customers-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }
    
    .summary-card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        border: 1px solid var(--border-color);
    }
    
    .summary-icon { font-size: var(--text-2xl); }
    .summary-label { font-size: var(--text-sm); color: var(--text-secondary); }
    .summary-value { font-size: var(--text-xl); font-weight: var(--font-semibold); }
    
    .form-row {
        display: flex;
        gap: var(--space-4);
        flex-wrap: wrap;
    }
    
    .form-row .form-group { min-width: 150px; }
    
    .form-actions {
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
        padding-top: var(--space-4);
        border-top: 1px solid var(--border-color);
    }
    
    .customer-avatar {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        background: var(--primary-light);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
    }
    
    .customer-name { font-weight: var(--font-medium); }
    .customer-company { font-size: var(--text-sm); color: var(--text-secondary); }
    .customer-number { font-size: var(--text-xs); color: var(--text-muted); font-family: var(--font-mono); }
    .customer-email { font-size: var(--text-sm); color: var(--text-secondary); }
    
    tr.inactive { opacity: 0.6; }
</style>

@code {
    [Parameter]
    public int? CustomerId { get; set; }
    
    private List<Customer> customers = new();
    private Customer? editingCustomer;
    private Customer? viewingCustomer;
    private List<CustomerTransactionItem> customerTransactions = new();
    private CustomerBalanceSummary balanceSummary = new();
    private bool isLoading = true;
    private bool isEditing = false;
    private bool isViewing = false;
    private bool isSaving = false;
    private string searchTerm = "";
    private bool showInactive = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomersAsync();
        
        // Check if we should open a specific customer or create new
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (uri.AbsolutePath.EndsWith("/new", StringComparison.OrdinalIgnoreCase))
        {
            CreateNewCustomer();
        }
        else if (CustomerId.HasValue && CustomerId.Value > 0)
        {
            var customer = customers.FirstOrDefault(c => c.Id == CustomerId.Value);
            if (customer != null)
            {
                await ViewCustomerAsync(customer);
            }
        }
    }

    private async Task LoadCustomersAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            customers = (await CustomerService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading customers: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<Customer> GetFilteredCustomers()
    {
        var filtered = customers.AsEnumerable();
        
        if (!showInactive)
            filtered = filtered.Where(c => c.IsActive);
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filtered = filtered.Where(c =>
                c.Name.ToLower().Contains(term) ||
                (c.CompanyName?.ToLower().Contains(term) ?? false) ||
                (c.Email?.ToLower().Contains(term) ?? false) ||
                c.CustomerNumber.ToLower().Contains(term));
        }
        
        return filtered.OrderBy(c => c.Name);
    }

    private void CreateNewCustomer()
    {
        editingCustomer = new Customer
        {
            IsActive = true,
            PaymentTermsDays = 30,
            PaymentTerms = "Net 30",
            BillingCountry = "USA",
            ShippingSameAsBilling = true
        };
        isEditing = true;
        errorMessage = null;
    }

    private async Task ViewCustomerAsync(Customer customer)
    {
        viewingCustomer = customer;
        isViewing = true;
        isEditing = false;
        editingCustomer = null;
        
        // Load transaction history and balance summary
        customerTransactions = (await CustomerService.GetCustomerTransactionsAsync(customer.Id)).ToList();
        balanceSummary = await CustomerService.GetCustomerBalanceSummaryAsync(customer.Id);
    }

    private void EditCustomer(Customer customer)
    {
        editingCustomer = new Customer
        {
            Id = customer.Id,
            CustomerNumber = customer.CustomerNumber,
            Name = customer.Name,
            CompanyName = customer.CompanyName,
            DisplayName = customer.DisplayName,
            FirstName = customer.FirstName,
            LastName = customer.LastName,
            Email = customer.Email,
            Phone = customer.Phone,
            Mobile = customer.Mobile,
            Website = customer.Website,
            BillingAddress1 = customer.BillingAddress1,
            BillingAddress2 = customer.BillingAddress2,
            BillingCity = customer.BillingCity,
            BillingState = customer.BillingState,
            BillingPostalCode = customer.BillingPostalCode,
            BillingCountry = customer.BillingCountry,
            ShippingSameAsBilling = customer.ShippingSameAsBilling,
            ShippingAddress1 = customer.ShippingAddress1,
            ShippingAddress2 = customer.ShippingAddress2,
            ShippingCity = customer.ShippingCity,
            ShippingState = customer.ShippingState,
            ShippingPostalCode = customer.ShippingPostalCode,
            ShippingCountry = customer.ShippingCountry,
            Balance = customer.Balance,
            CreditLimit = customer.CreditLimit,
            PaymentTerms = customer.PaymentTerms,
            PaymentTermsDays = customer.PaymentTermsDays,
            TaxRate = customer.TaxRate,
            IsTaxExempt = customer.IsTaxExempt,
            TaxExemptNumber = customer.TaxExemptNumber,
            IsActive = customer.IsActive,
            Notes = customer.Notes
        };
        isEditing = true;
        isViewing = false;
        viewingCustomer = null;
        errorMessage = null;
    }

    private void EditFromView()
    {
        if (viewingCustomer != null)
        {
            EditCustomer(viewingCustomer);
        }
    }

    private void BackToList()
    {
        isViewing = false;
        isEditing = false;
        viewingCustomer = null;
        editingCustomer = null;
        Navigation.NavigateTo("/customers");
    }

    private void CancelEdit()
    {
        if (viewingCustomer != null)
        {
            // Go back to viewing if we were editing from view
            isEditing = false;
            editingCustomer = null;
            errorMessage = null;
            isViewing = true;
        }
        else
        {
            isEditing = false;
            editingCustomer = null;
            errorMessage = null;
            Navigation.NavigateTo("/customers");
        }
    }

    private async Task SaveCustomerAsync()
    {
        if (editingCustomer == null) return;
        
        isSaving = true;
        errorMessage = null;
        
        try
        {
            // Set payment terms text based on days
            editingCustomer.PaymentTerms = editingCustomer.PaymentTermsDays == 0 
                ? "Due on Receipt" 
                : $"Net {editingCustomer.PaymentTermsDays}";
            
            var savedCustomerId = editingCustomer.Id;
            
            if (editingCustomer.Id > 0)
            {
                await CustomerService.UpdateAsync(editingCustomer);
            }
            else
            {
                var created = await CustomerService.CreateAsync(editingCustomer);
                savedCustomerId = created.Id;
            }
            
            await LoadCustomersAsync();
            
            // If we were editing from view, go back to viewing the updated customer
            if (viewingCustomer != null)
            {
                var updatedCustomer = customers.FirstOrDefault(c => c.Id == savedCustomerId);
                if (updatedCustomer != null)
                {
                    await ViewCustomerAsync(updatedCustomer);
                    return;
                }
            }
            
            CancelEdit();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving customer: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadCustomersAsync();
        }
    }

    private string GetPageTitle()
    {
        if (isEditing)
            return editingCustomer?.Id > 0 ? "Edit Customer" : "New Customer";
        if (isViewing && viewingCustomer != null)
            return viewingCustomer.FullName;
        return "Customers";
    }

    private string GetPageSubtitle()
    {
        if (isEditing)
            return editingCustomer?.Id > 0 ? $"Editing {editingCustomer.Name}" : "Add a new customer";
        if (isViewing && viewingCustomer != null)
            return viewingCustomer.CustomerNumber;
        return "Manage your customers and their information";
    }
}
