@page "/settings"
@inject ICompanyService CompanyService
@inject IUserPreferencesService UserPreferencesService
@inject IBackupService BackupService
@inject IJSRuntime JSRuntime

<PageHeader Title="Company Settings" Subtitle="Manage your business profile and preferences" />

@if (isLoading)
{
    <LoadingSpinner Text="Loading company settings..." />
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
        <button class="btn btn-sm btn-secondary ms-3" @onclick="LoadDataAsync">Retry</button>
    </div>
}
else if (company != null)
{
    <div class="settings-container">
        @if (showSuccessMessage)
        {
            <div class="alert alert-success mb-4">
                <span>‚úì</span> Company settings saved successfully!
            </div>
        }

        <div class="tabs">
            <button class="tab @(activeTab == "profile" ? "active" : "")" @onclick="@(() => SetActiveTab("profile"))">
                Business Profile
            </button>
            <button class="tab @(activeTab == "financial" ? "active" : "")" @onclick="@(() => SetActiveTab("financial"))">
                Financial Settings
            </button>
            <button class="tab @(activeTab == "invoicing" ? "active" : "")" @onclick="@(() => SetActiveTab("invoicing"))">
                Invoicing
            </button>
            <button class="tab @(activeTab == "branding" ? "active" : "")" @onclick="@(() => SetActiveTab("branding"))">
                Branding
            </button>
            <button class="tab @(activeTab == "preferences" ? "active" : "")" @onclick="@(() => SetActiveTab("preferences"))">
                Preferences
            </button>
            <button class="tab @(activeTab == "data" ? "active" : "")" @onclick="@(() => SetActiveTab("data"))">
                Data Management
            </button>
        </div>

        <EditForm Model="company" OnValidSubmit="SaveCompanyAsync">
            <DataAnnotationsValidator />
            
            @* Business Profile Tab *@
            <div class="tab-content @(activeTab == "profile" ? "active" : "")">
                <Card Title="Business Information">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label form-label-required">Company Name</label>
                            <InputText @bind-Value="company.Name" class="form-control" placeholder="Enter company name" />
                            <ValidationMessage For="() => company.Name" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Legal Name</label>
                            <InputText @bind-Value="company.LegalName" class="form-control" placeholder="Legal business name (if different)" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">DBA (Doing Business As)</label>
                            <InputText @bind-Value="company.DbaName" class="form-control" placeholder="Trade name" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Tax ID / EIN</label>
                            <InputText @bind-Value="company.TaxId" class="form-control" placeholder="XX-XXXXXXX" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Business Type</label>
                            <InputSelect @bind-Value="company.BusinessType" class="form-control">
                                @foreach (var type in Enum.GetValues<BusinessType>())
                                {
                                    <option value="@type">@FormatEnumName(type.ToString())</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Industry</label>
                            <InputSelect @bind-Value="company.Industry" class="form-control">
                                @foreach (var industry in Enum.GetValues<IndustryType>().OrderBy(i => i.ToString()))
                                {
                                    <option value="@industry">@FormatEnumName(industry.ToString())</option>
                                }
                            </InputSelect>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Business Description</label>
                        <InputTextArea @bind-Value="company.Description" class="form-control" rows="3" 
                            placeholder="Brief description of your business" />
                    </div>
                </Card>

                <Card Title="Business Address" CssClass="mt-4">
                    <div class="form-group">
                        <label class="form-label">Address Line 1</label>
                        <InputText @bind-Value="company.Address1" class="form-control" placeholder="Street address" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address Line 2</label>
                        <InputText @bind-Value="company.Address2" class="form-control" placeholder="Suite, unit, building, floor, etc." />
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">City</label>
                            <InputText @bind-Value="company.City" class="form-control" placeholder="City" />
                        </div>
                        <div class="form-group" style="width: 150px;">
                            <label class="form-label">State</label>
                            <InputText @bind-Value="company.State" class="form-control" placeholder="State" />
                        </div>
                        <div class="form-group" style="width: 150px;">
                            <label class="form-label">ZIP Code</label>
                            <InputText @bind-Value="company.PostalCode" class="form-control" placeholder="ZIP" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <InputText @bind-Value="company.Country" class="form-control" placeholder="Country" />
                    </div>
                </Card>

                <Card Title="Contact Information" CssClass="mt-4">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Phone</label>
                            <InputText @bind-Value="company.Phone" class="form-control" placeholder="(555) 555-5555" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Fax</label>
                            <InputText @bind-Value="company.Fax" class="form-control" placeholder="(555) 555-5555" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Email</label>
                            <InputText @bind-Value="company.Email" class="form-control" type="email" placeholder="info@company.com" />
                            <ValidationMessage For="() => company.Email" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Website</label>
                            <InputText @bind-Value="company.Website" class="form-control" placeholder="https://www.company.com" />
                            <ValidationMessage For="() => company.Website" />
                        </div>
                    </div>
                </Card>
            </div>

            @* Financial Settings Tab *@
            <div class="tab-content @(activeTab == "financial" ? "active" : "")">
                <Card Title="Accounting Preferences">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Accounting Method</label>
                            <InputSelect @bind-Value="company.AccountingMethod" class="form-control">
                                <option value="@AccountingMethod.Accrual">Accrual</option>
                                <option value="@AccountingMethod.Cash">Cash</option>
                            </InputSelect>
                            <span class="form-text">
                                @(company.AccountingMethod == AccountingMethod.Accrual 
                                    ? "Record income when earned and expenses when incurred" 
                                    : "Record income when received and expenses when paid")
                            </span>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Inventory Method</label>
                            <InputSelect @bind-Value="company.InventoryMethod" class="form-control">
                                <option value="@InventoryMethod.FIFO">FIFO (First In, First Out)</option>
                                <option value="@InventoryMethod.LIFO">LIFO (Last In, First Out)</option>
                                <option value="@InventoryMethod.AverageCost">Average Cost</option>
                            </InputSelect>
                        </div>
                    </div>
                </Card>

                <Card Title="Fiscal Year" CssClass="mt-4">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Fiscal Year Start Month</label>
                            <InputSelect @bind-Value="company.FiscalYearStartMonth" class="form-control">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </InputSelect>
                            <span class="form-text">Fiscal Year: @company.FiscalYearDisplay</span>
                        </div>
                        <div class="form-group flex-1">
                            <div class="form-check mt-4">
                                <InputCheckbox @bind-Value="company.TaxYearSameAsFiscal" class="form-check-input" id="taxYearSame" />
                                <label class="form-check-label" for="taxYearSame">Income tax year same as fiscal year</label>
                            </div>
                        </div>
                    </div>
                </Card>

                <Card Title="Currency & Tax" CssClass="mt-4">
                    <div class="form-row">
                        <div class="form-group" style="width: 150px;">
                            <label class="form-label">Currency</label>
                            <InputSelect @bind-Value="company.Currency" class="form-control">
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                            </InputSelect>
                        </div>
                        <div class="form-group" style="width: 100px;">
                            <label class="form-label">Symbol</label>
                            <InputText @bind-Value="company.CurrencySymbol" class="form-control" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Default Tax Rate (%)</label>
                            <InputNumber @bind-Value="company.DefaultTaxRate" class="form-control" step="0.01" />
                            <ValidationMessage For="() => company.DefaultTaxRate" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tax Agency Name</label>
                        <InputText @bind-Value="company.TaxAgencyName" class="form-control" placeholder="e.g., State Tax Board" />
                    </div>
                </Card>
            </div>

            @* Invoicing Tab *@
            <div class="tab-content @(activeTab == "invoicing" ? "active" : "")">
                <Card Title="Invoice Numbering">
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Invoice Number Prefix</label>
                            <InputText @bind-Value="company.InvoicePrefix" class="form-control" />
                            <span class="form-text">Example: @(company.InvoicePrefix)@(company.NextInvoiceNumber)</span>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Next Invoice Number</label>
                            <InputNumber @bind-Value="company.NextInvoiceNumber" class="form-control" min="1" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Bill Number Prefix</label>
                            <InputText @bind-Value="company.BillPrefix" class="form-control" />
                            <span class="form-text">Example: @(company.BillPrefix)@(company.NextBillNumber)</span>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Next Bill Number</label>
                            <InputNumber @bind-Value="company.NextBillNumber" class="form-control" min="1" />
                        </div>
                    </div>
                </Card>

                <Card Title="Payment Terms" CssClass="mt-4">
                    <div class="form-group" style="max-width: 300px;">
                        <label class="form-label">Default Payment Terms (Days)</label>
                        <InputSelect @bind-Value="company.DefaultPaymentTermsDays" class="form-control">
                            <option value="0">Due on Receipt</option>
                            <option value="7">Net 7</option>
                            <option value="10">Net 10</option>
                            <option value="15">Net 15</option>
                            <option value="30">Net 30</option>
                            <option value="45">Net 45</option>
                            <option value="60">Net 60</option>
                            <option value="90">Net 90</option>
                        </InputSelect>
                    </div>
                </Card>

                <Card Title="Default Invoice Content" CssClass="mt-4">
                    <div class="form-group">
                        <label class="form-label">Invoice Notes</label>
                        <InputTextArea @bind-Value="company.InvoiceNotes" class="form-control" rows="3" 
                            placeholder="Notes that appear on all invoices (e.g., Thank you for your business!)" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Invoice Terms & Conditions</label>
                        <InputTextArea @bind-Value="company.InvoiceTerms" class="form-control" rows="4" 
                            placeholder="Payment terms and conditions" />
                    </div>
                </Card>
            </div>

            @* Branding Tab *@
            <div class="tab-content @(activeTab == "branding" ? "active" : "")">
                <Card Title="Company Logo">
                    <div class="logo-section">
                        <div class="logo-preview">
                            @if (company.Logo != null && company.Logo.Length > 0)
                            {
                                <img src="data:@(company.LogoContentType ?? "image/png");base64,@Convert.ToBase64String(company.Logo)" 
                                     alt="Company Logo" class="logo-image" />
                            }
                            else
                            {
                                <div class="logo-placeholder">
                                    <span class="logo-placeholder-icon">üè¢</span>
                                    <span class="logo-placeholder-text">No logo uploaded</span>
                                </div>
                            }
                        </div>
                        <div class="logo-actions">
                            <InputFile OnChange="HandleLogoUpload" accept="image/*" class="d-none" id="logoUpload" />
                            <label for="logoUpload" class="btn btn-secondary">
                                üì∑ Upload Logo
                            </label>
                            @if (company.Logo != null)
                            {
                                <button type="button" class="btn btn-secondary" @onclick="RemoveLogo">
                                    üóëÔ∏è Remove Logo
                                </button>
                            }
                            <span class="form-text d-block mt-2">Recommended size: 300x100 pixels. Max 2MB.</span>
                        </div>
                    </div>
                </Card>

                <Card Title="Brand Colors" CssClass="mt-4">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Primary Color</label>
                            <div class="color-picker-group">
                                <input type="color" @bind="company.PrimaryColor" class="color-picker" />
                                <InputText @bind-Value="company.PrimaryColor" class="form-control" style="width: 100px;" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Secondary Color</label>
                            <div class="color-picker-group">
                                <input type="color" @bind="company.SecondaryColor" class="color-picker" />
                                <InputText @bind-Value="company.SecondaryColor" class="form-control" style="width: 100px;" />
                            </div>
                        </div>
                    </div>
                    <div class="color-preview mt-4">
                        <span class="form-text">Preview:</span>
                        <div class="color-preview-sample" style="background-color: @company.PrimaryColor; color: white;">
                            Primary Color
                        </div>
                        <div class="color-preview-sample" style="background-color: @company.SecondaryColor; color: white;">
                            Secondary Color
                        </div>
                    </div>
                </Card>
            </div>

            @* User Preferences Tab *@
            <div class="tab-content @(activeTab == "preferences" ? "active" : "")">
                @if (preferences != null)
                {
                    <Card Title="Display Settings">
                        <div class="form-row">
                            <div class="form-group flex-1">
                                <label class="form-label">Theme</label>
                                <InputSelect @bind-Value="preferences.Theme" class="form-control">
                                    <option value="@ApplicationTheme.System">System Default</option>
                                    <option value="@ApplicationTheme.Light">Light</option>
                                    <option value="@ApplicationTheme.Dark">Dark</option>
                                </InputSelect>
                            </div>
                            <div class="form-group flex-1">
                                <label class="form-label">Default Page Size</label>
                                <InputSelect @bind-Value="preferences.DefaultPageSize" class="form-control">
                                    <option value="10">10 items</option>
                                    <option value="25">25 items</option>
                                    <option value="50">50 items</option>
                                    <option value="100">100 items</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group flex-1">
                                <label class="form-label">Default Landing Page</label>
                                <InputSelect @bind-Value="preferences.DefaultLandingPage" class="form-control">
                                    <option value="/">Dashboard</option>
                                    <option value="/invoices">Invoices</option>
                                    <option value="/bills">Bills</option>
                                    <option value="/customers">Customers</option>
                                    <option value="/accounts">Chart of Accounts</option>
                                    <option value="/reports">Reports</option>
                                </InputSelect>
                            </div>
                            <div class="form-group flex-1">
                                <div class="form-check mt-4">
                                    <InputCheckbox @bind-Value="preferences.SidebarCollapsed" class="form-check-input" id="sidebarCollapsed" />
                                    <label class="form-check-label" for="sidebarCollapsed">Sidebar collapsed by default</label>
                                </div>
                            </div>
                        </div>
                    </Card>

                    <Card Title="Date & Number Formatting" CssClass="mt-4">
                        <div class="form-row">
                            <div class="form-group flex-1">
                                <label class="form-label">Date Format</label>
                                <InputSelect @bind-Value="preferences.DateFormat" class="form-control">
                                    <option value="MM/dd/yyyy">MM/DD/YYYY (12/31/2024)</option>
                                    <option value="dd/MM/yyyy">DD/MM/YYYY (31/12/2024)</option>
                                    <option value="yyyy-MM-dd">YYYY-MM-DD (2024-12-31)</option>
                                    <option value="MMMM d, yyyy">Month D, YYYY (December 31, 2024)</option>
                                </InputSelect>
                            </div>
                            <div class="form-group flex-1">
                                <label class="form-label">Time Format</label>
                                <InputSelect @bind-Value="preferences.TimeFormat" class="form-control">
                                    <option value="@TimeFormatPreference.TwelveHour">12-hour (2:30 PM)</option>
                                    <option value="@TimeFormatPreference.TwentyFourHour">24-hour (14:30)</option>
                                </InputSelect>
                            </div>
                        </div>
                        <div class="form-group" style="max-width: 300px;">
                            <label class="form-label">Number Format</label>
                            <InputSelect @bind-Value="preferences.NumberFormat" class="form-control">
                                <option value="@NumberFormatPreference.USFormat">US (1,234.56)</option>
                                <option value="@NumberFormatPreference.EuropeanFormat">European (1.234,56)</option>
                                <option value="@NumberFormatPreference.IndianFormat">Indian (1,23,456.78)</option>
                                <option value="@NumberFormatPreference.SwissFormat">Swiss (1'234.56)</option>
                            </InputSelect>
                        </div>
                    </Card>

                    <Card Title="Notifications & Alerts" CssClass="mt-4">
                        <div class="form-row">
                            <div class="form-group flex-1">
                                <div class="form-check">
                                    <InputCheckbox @bind-Value="preferences.ShowOverdueInvoiceAlerts" class="form-check-input" id="overdueInvoice" />
                                    <label class="form-check-label" for="overdueInvoice">Show overdue invoice alerts</label>
                                </div>
                                <div class="form-check mt-2">
                                    <InputCheckbox @bind-Value="preferences.ShowOverdueBillAlerts" class="form-check-input" id="overdueBill" />
                                    <label class="form-check-label" for="overdueBill">Show overdue bill alerts</label>
                                </div>
                                <div class="form-check mt-2">
                                    <InputCheckbox @bind-Value="preferences.ShowLowInventoryAlerts" class="form-check-input" id="lowInventory" />
                                    <label class="form-check-label" for="lowInventory">Show low inventory alerts</label>
                                </div>
                            </div>
                            <div class="form-group flex-1">
                                <label class="form-label">Upcoming Due Alert (Days Before)</label>
                                <InputNumber @bind-Value="preferences.UpcomingDueAlertDays" class="form-control" min="0" max="30" style="max-width: 150px;" />
                            </div>
                        </div>
                    </Card>

                    <Card Title="Confirmations" CssClass="mt-4">
                        <div class="form-check">
                            <InputCheckbox @bind-Value="preferences.ConfirmBeforeDelete" class="form-check-input" id="confirmDelete" />
                            <label class="form-check-label" for="confirmDelete">Confirm before deleting records</label>
                        </div>
                        <div class="form-check mt-2">
                            <InputCheckbox @bind-Value="preferences.ConfirmBeforeVoid" class="form-check-input" id="confirmVoid" />
                            <label class="form-check-label" for="confirmVoid">Confirm before voiding transactions</label>
                        </div>
                        <div class="form-check mt-2">
                            <InputCheckbox @bind-Value="preferences.AutoSaveDrafts" class="form-check-input" id="autoSave" />
                            <label class="form-check-label" for="autoSave">Auto-save draft transactions</label>
                        </div>
                    </Card>

                    <Card Title="Dashboard Widgets" CssClass="mt-4">
                        <p class="form-text mb-3">Choose which widgets to display on your dashboard:</p>
                        <div class="widget-grid">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="preferences.ShowProfitLossWidget" class="form-check-input" id="plWidget" />
                                <label class="form-check-label" for="plWidget">Profit & Loss</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox @bind-Value="preferences.ShowCashFlowWidget" class="form-check-input" id="cfWidget" />
                                <label class="form-check-label" for="cfWidget">Cash Flow</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox @bind-Value="preferences.ShowReceivablesWidget" class="form-check-input" id="arWidget" />
                                <label class="form-check-label" for="arWidget">Accounts Receivable</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox @bind-Value="preferences.ShowPayablesWidget" class="form-check-input" id="apWidget" />
                                <label class="form-check-label" for="apWidget">Accounts Payable</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox @bind-Value="preferences.ShowRecentTransactionsWidget" class="form-check-input" id="rtWidget" />
                                <label class="form-check-label" for="rtWidget">Recent Transactions</label>
                            </div>
                        </div>
                    </Card>

                    <div class="form-actions mt-4">
                        <button type="button" class="btn btn-primary" @onclick="SavePreferencesAsync" disabled="@isSavingPreferences">
                            @(isSavingPreferences ? "Saving..." : "üíæ Save Preferences")
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="ResetPreferencesAsync">
                            üîÑ Reset to Defaults
                        </button>
                    </div>
                }
            </div>

            @* Data Management Tab *@
            <div class="tab-content @(activeTab == "data" ? "active" : "")">
                <Card Title="Backup Data">
                    <p class="mb-4">Create a backup of all your data including company information, transactions, customers, vendors, and settings.</p>
                    
                    @if (backupStats != null)
                    {
                        <div class="backup-stats mb-4">
                            <div class="stat-item">
                                <span class="stat-label">Total Records:</span>
                                <span class="stat-value">@backupStats.TotalRecords.ToString("N0")</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Last Backup:</span>
                                <span class="stat-value">@(backupStats.LastBackupDate?.ToString("g") ?? "Never")</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Backup Size:</span>
                                <span class="stat-value">@backupStats.LastBackupSizeDisplay</span>
                            </div>
                        </div>
                    }

                    <div class="backup-actions">
                        <button type="button" class="btn btn-primary" @onclick="CreateBackupAsync" disabled="@isBackingUp">
                            @if (isBackingUp)
                            {
                                <span>Creating Backup...</span>
                            }
                            else
                            {
                                <span>üì¶ Create Backup</span>
                            }
                        </button>
                    </div>

                    @if (!string.IsNullOrEmpty(backupMessage))
                    {
                        <div class="alert @(backupSuccess ? "alert-success" : "alert-danger") mt-3">
                            @backupMessage
                        </div>
                    }
                </Card>

                <Card Title="Restore Data" CssClass="mt-4">
                    <div class="alert alert-warning mb-4">
                        <strong>Warning:</strong> Restoring data will replace ALL existing data. A backup will be created automatically before restore.
                    </div>
                    
                    <div class="restore-section">
                        <InputFile OnChange="HandleRestoreFileSelected" accept=".zip" class="d-none" id="restoreFile" />
                        <label for="restoreFile" class="btn btn-secondary">
                            üìÅ Select Backup File
                        </label>
                        
                        @if (selectedRestoreFile != null)
                        {
                            <div class="selected-file mt-3">
                                <span class="file-name">@selectedRestoreFile.Name</span>
                                <span class="file-size">(@FormatFileSize(selectedRestoreFile.Size))</span>
                            </div>
                            
                            <button type="button" class="btn btn-danger mt-3" @onclick="RestoreBackupAsync" disabled="@isRestoring">
                                @(isRestoring ? "Restoring..." : "‚ö†Ô∏è Restore Backup")
                            </button>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(restoreMessage))
                    {
                        <div class="alert @(restoreSuccess ? "alert-success" : "alert-danger") mt-3">
                            @restoreMessage
                        </div>
                    }
                </Card>

                <Card Title="Backup History" CssClass="mt-4">
                    @if (backupHistory != null && backupHistory.Any())
                    {
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var backup in backupHistory.Take(10))
                                {
                                    <tr>
                                        <td>@backup.CreatedAt.ToString("g")</td>
                                        <td>@backup.FileName</td>
                                        <td>@backup.FileSizeDisplay</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-secondary" @onclick="() => DownloadBackup(backup)">
                                                ‚¨áÔ∏è Download
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">No backups found.</p>
                    }
                </Card>
            </div>

            <div class="form-actions mt-6">
                <button type="submit" class="btn btn-primary btn-lg" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>üíæ Save Changes</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
}

<style>
    .settings-container {
        max-width: 900px;
    }
    
    .form-row {
        display: flex;
        gap: var(--space-4);
        flex-wrap: wrap;
    }
    
    .form-row .form-group {
        min-width: 200px;
    }
    
    .form-actions {
        display: flex;
        gap: var(--space-3);
        padding-top: var(--space-4);
        border-top: 1px solid var(--border-color);
    }
    
    .logo-section {
        display: flex;
        gap: var(--space-6);
        align-items: flex-start;
    }
    
    .logo-preview {
        width: 200px;
        height: 100px;
        border: 2px dashed var(--border-color);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background-color: var(--bg-secondary);
    }
    
    .logo-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .logo-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        color: var(--text-muted);
    }
    
    .logo-placeholder-icon {
        font-size: var(--text-3xl);
        opacity: 0.5;
    }
    
    .logo-placeholder-text {
        font-size: var(--text-sm);
    }
    
    .logo-actions {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .color-picker-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }
    
    .color-picker {
        width: 50px;
        height: 38px;
        padding: 0;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        cursor: pointer;
    }
    
    .color-preview {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }
    
    .color-preview-sample {
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
    }
    
    .widget-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--space-3);
    }
    
    .backup-stats {
        display: flex;
        gap: var(--space-6);
        flex-wrap: wrap;
        padding: var(--space-4);
        background-color: var(--bg-secondary);
        border-radius: var(--radius-lg);
    }
    
    .stat-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }
    
    .stat-label {
        font-size: var(--text-sm);
        color: var(--text-muted);
    }
    
    .stat-value {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
    }
    
    .backup-actions {
        display: flex;
        gap: var(--space-3);
    }
    
    .restore-section {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .selected-file {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background-color: var(--bg-secondary);
        border-radius: var(--radius-md);
    }
    
    .file-name {
        font-weight: var(--font-medium);
    }
    
    .file-size {
        color: var(--text-muted);
        font-size: var(--text-sm);
    }
</style>

@code {
    private Company? company;
    private UserPreferences? preferences;
    private BackupStatistics? backupStats;
    private List<BackupInfo>? backupHistory;
    
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isSavingPreferences = false;
    private bool isBackingUp = false;
    private bool isRestoring = false;
    private bool showSuccessMessage = false;
    private string activeTab = "profile";
    private string? errorMessage;
    
    // Backup/Restore state
    private string? backupMessage;
    private bool backupSuccess;
    private string? restoreMessage;
    private bool restoreSuccess;
    private IBrowserFile? selectedRestoreFile;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            company = await CompanyService.GetCompanyAsync();
            preferences = await UserPreferencesService.GetPreferencesAsync();
            backupStats = await BackupService.GetBackupStatisticsAsync();
            backupHistory = await BackupService.GetBackupHistoryAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading settings: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveCompanyAsync()
    {
        if (company == null) return;
        
        isSaving = true;
        showSuccessMessage = false;
        
        try
        {
            await CompanyService.UpdateCompanyAsync(company);
            showSuccessMessage = true;
            
            // Auto-hide success message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                showSuccessMessage = false;
                InvokeAsync(StateHasChanged);
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleLogoUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        // Validate file size (max 2MB)
        if (file.Size > 2 * 1024 * 1024)
        {
            // TODO: Show error message
            return;
        }

        // Validate file type
        if (!file.ContentType.StartsWith("image/"))
        {
            // TODO: Show error message
            return;
        }

        using var stream = file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024);
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);
        
        if (company != null)
        {
            company.Logo = memoryStream.ToArray();
            company.LogoContentType = file.ContentType;
        }
    }

    private void RemoveLogo()
    {
        if (company != null)
        {
            company.Logo = null;
            company.LogoContentType = null;
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private string FormatEnumName(string enumName)
    {
        // Convert PascalCase to Title Case with spaces
        return System.Text.RegularExpressions.Regex.Replace(
            enumName, 
            "([a-z])([A-Z])", 
            "$1 $2"
        );
    }

    // User Preferences Methods
    private async Task SavePreferencesAsync()
    {
        if (preferences == null) return;
        
        isSavingPreferences = true;
        try
        {
            await UserPreferencesService.UpdatePreferencesAsync(preferences);
            showSuccessMessage = true;
            
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                showSuccessMessage = false;
                InvokeAsync(StateHasChanged);
            });
        }
        finally
        {
            isSavingPreferences = false;
        }
    }

    private async Task ResetPreferencesAsync()
    {
        isSavingPreferences = true;
        try
        {
            preferences = await UserPreferencesService.ResetToDefaultsAsync();
        }
        finally
        {
            isSavingPreferences = false;
        }
    }

    // Backup/Restore Methods
    private async Task CreateBackupAsync()
    {
        isBackingUp = true;
        backupMessage = null;
        
        try
        {
            var result = await BackupService.CreateBackupAsync();
            backupSuccess = result.Success;
            backupMessage = result.Message;
            
            if (result.Success)
            {
                // Refresh backup stats and history
                backupStats = await BackupService.GetBackupStatisticsAsync();
                backupHistory = await BackupService.GetBackupHistoryAsync();
            }
        }
        catch (Exception ex)
        {
            backupSuccess = false;
            backupMessage = $"Backup failed: {ex.Message}";
        }
        finally
        {
            isBackingUp = false;
        }
    }

    private void HandleRestoreFileSelected(InputFileChangeEventArgs e)
    {
        selectedRestoreFile = e.File;
        restoreMessage = null;
    }

    private async Task RestoreBackupAsync()
    {
        if (selectedRestoreFile == null) return;
        
        isRestoring = true;
        restoreMessage = null;
        
        try
        {
            using var stream = selectedRestoreFile.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024); // 100MB max
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;
            
            var result = await BackupService.RestoreBackupAsync(memoryStream);
            restoreSuccess = result.Success;
            restoreMessage = result.Message;
            
            if (result.Success)
            {
                // Reload all data after restore
                await LoadDataAsync();
                selectedRestoreFile = null;
            }
        }
        catch (Exception ex)
        {
            restoreSuccess = false;
            restoreMessage = $"Restore failed: {ex.Message}";
        }
        finally
        {
            isRestoring = false;
        }
    }

    private async Task DownloadBackup(BackupInfo backup)
    {
        try
        {
            var fileBytes = await File.ReadAllBytesAsync(backup.FilePath);
            var base64 = Convert.ToBase64String(fileBytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", backup.FileName, base64);
            backupMessage = "Download started!";
            backupSuccess = true;
        }
        catch (Exception ex)
        {
            backupMessage = $"Error downloading backup: {ex.Message}";
            backupSuccess = false;
        }
    }

    private string FormatFileSize(long size)
    {
        if (size < 1024)
            return $"{size} B";
        if (size < 1024 * 1024)
            return $"{size / 1024.0:F1} KB";
        return $"{size / (1024.0 * 1024.0):F1} MB";
    }
}
